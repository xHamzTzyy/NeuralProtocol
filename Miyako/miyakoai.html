<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>N E U R A L   P R O T O C O L</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Poppins:wght@300;400;600&family=Creepster&display=swap"
    rel="stylesheet">
  <style>
    /* ========== RED MINIMAL THEME — TIDAK MENGUBAH SATU BARIS JAVASCRIPT ========== */
    :root {
      --red-dominant: #e11d2f;        /* merah berani */
      --red-soft: #b81c2c;
      --red-glow: rgba(225, 29, 47, 0.4);
      --dark-bg: #0b0b0f;              /* deep black with warm tint */
      --card-bg: #15151a;               /* slightly lighter for panels */
      --border-light: rgba(225, 29, 47, 0.3);
      --glass-red: rgba(225, 29, 47, 0.08);
      --glass-white: rgba(255, 255, 255, 0.05);
      --text-primary: #f0f0f0;
      --text-muted: #a0a0a8;
      --icon-bg-user: #e11d2f;
      --icon-bg-bot: #1e1e26;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: radial-gradient(circle at 30% 30%, #1a0b1a 0%, #000 100%);
      font-family: 'Poppins', sans-serif;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* subtle red overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 80% 10%, rgba(225,29,47,0.12) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* PULSE merah bukan lime */
    @keyframes pulse-red {
      0% { box-shadow: 0 0 5px var(--red-glow); }
      50% { box-shadow: 0 0 20px var(--red-dominant); }
      100% { box-shadow: 0 0 5px var(--red-glow); }
    }

    .chat-header {
      background: rgba(10, 10, 15, 0.8);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      color: var(--red-dominant);
      padding: 14px 10px;
      text-align: center;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 3;
      border-bottom: 2px solid var(--red-dominant);
      animation: pulse-red 4s infinite;
      letter-spacing: 1px;
    }

    .chat-header h1 {
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 0;
      font-size: 24px;
      text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
    }

    .chat-header p {
      margin: 2px 0 0 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #ccc;
      opacity: 0.8;
    }

    #menuBtn {
      position: fixed;
      top: 20px; left: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 6;
      color: var(--red-dominant);
      transition: 0.2s;
    }
    #menuBtn:hover { transform: scale(1.1); opacity: 0.9; }

    #sideMenu {
      position: fixed;
      top: 0; left: -260px;
      width: 220px; height: 100vh;
      background: rgba(15, 15, 20, 0.97);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-right: 2px solid var(--red-dominant);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: .3s cubic-bezier(0.2, 0, 0, 1);
      z-index: 5000;
    }

    #sideMenu h3 { 
      color: var(--red-dominant); 
      font-size: 24px; 
      margin-bottom: 20px; 
      text-align: center; 
      font-weight: 500;
      letter-spacing: -0.5px;
    }

    #sideMenu button {
      display: flex; align-items: center; gap: 10px;
      padding: 12px; border: none; border-radius: 30px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-light);
      color: #ddd; 
      cursor: pointer; 
      transition: 0.15s;
    }
    #sideMenu button:hover { 
      background: var(--red-dominant); 
      color: #000; 
      border-color: var(--red-dominant); 
      box-shadow: 0 0 12px var(--red-glow); 
    }

    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4; display: none; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      position: relative;
      z-index: 1;
      padding: 100px 15px 120px 15px;
    }

    #scrollBottomBtn {
      position: fixed;
      bottom: 100px; right: 25px;
      background: var(--red-dominant);
      color: #000; 
      border: none; 
      border-radius: 50%;
      width: 45px; height: 45px;
      font-size: 18px; display: none;
      align-items: center; justify-content: center;
      cursor: pointer; z-index: 3;
      box-shadow: 0 0 15px var(--red-glow);
    }
    #scrollBottomBtn:hover { background: #c01a2b; }

    .message { display: flex; align-items: flex-start; margin-bottom: 20px; }
    .message.user { justify-content: flex-end; }

    .message .icon {
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; margin: 0 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .message.user .icon { background: var(--icon-bg-user); color: #000; }
    .message.bot .icon { background: var(--icon-bg-bot); color: var(--red-dominant); border: 1px solid var(--red-dominant); }

    .message .text {
      padding: 14px 20px;
      border-radius: 20px;
      max-width: 75%;
      font-size: 14.5px;
      background: rgba(25, 25, 30, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-light);
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.5);
      color: #f0f0f0;
    }
    .message.user .text { 
      border-bottom-right-radius: 2px; 
      border-left: 4px solid var(--red-dominant); 
    }
    .message.bot .text { 
      border-bottom-left-radius: 2px; 
      border-right: 4px solid var(--red-dominant); 
    }

    /* ===== MESSAGE WRAPPER & ACTION BUTTONS ===== */
    .message-wrapper {
      display: flex;
      flex-direction: column;
      max-width: 75%;
      gap: 6px;
    }
    .message.user .message-wrapper { align-items: flex-end; }
    .message.bot .message-wrapper { align-items: flex-start; }

    .message .text { max-width: 100%; }

    .msg-actions {
      display: flex;
      gap: 6px;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }
    .message-wrapper:hover .msg-actions {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .msg-action-btn {
      display: flex; align-items: center; gap: 5px;
      padding: 4px 10px;
      border: 1px solid var(--border-light);
      border-radius: 20px;
      background: rgba(225, 29, 47, 0.06);
      color: rgba(255,255,255,0.7);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(6px);
      font-family: 'Poppins', sans-serif;
      white-space: nowrap;
    }
    .msg-action-btn:hover {
      background: var(--red-dominant);
      color: #000;
      border-color: var(--red-dominant);
      box-shadow: 0 0 10px var(--red-glow);
    }
    .msg-action-btn.success {
      background: rgba(225, 29, 47, 0.2);
      color: var(--red-dominant);
      border-color: var(--red-dominant);
    }
    .msg-action-btn i { font-size: 10px; }

    /* ===== LOADING ANIMATION (merah) ===== */
    .thinking-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .thinking-dots {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .thinking-dot {
      width: 8px; height: 8px;
      background: var(--red-dominant);
      border-radius: 50%;
      animation: thinkBounce 1.2s ease-in-out infinite;
      box-shadow: 0 0 6px var(--red-glow);
    }
    .thinking-dot:nth-child(1) { animation-delay: 0s; }
    .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinkBounce {
      0%, 80%, 100% { transform: scale(0.6) translateY(0); opacity: 0.4; }
      40% { transform: scale(1.2) translateY(-6px); opacity: 1; }
    }

    .thinking-label {
      font-size: 12px;
      color: var(--red-dominant);
      opacity: 0.8;
      letter-spacing: 1px;
      animation: fadeInOut 1.5s ease-in-out infinite;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }

    /* Neural scan line effect saat loading — merah */
    .scan-line {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 2px;
      background: linear-gradient(90deg, transparent, var(--red-dominant), transparent);
      animation: scanMove 1.5s ease-in-out infinite;
      border-radius: 20px;
      overflow: hidden;
    }

    @keyframes scanMove {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(60px); opacity: 0; }
    }

    .thinking-wrapper {
      position: relative;
      overflow: hidden;
    }

    /* ===== TYPEWRITER CHAR ANIMATION ===== */
    .char-animated {
      display: inline;
      opacity: 0;
      animation: charAppear 0.03s forwards;
    }

    @keyframes charAppear {
      to { opacity: 1; }
    }

    /* Cursor kedip setelah typing — merah */
    .typing-cursor {
      display: inline-block;
      width: 2px; height: 14px;
      background: var(--red-dominant);
      margin-left: 2px;
      vertical-align: middle;
      animation: cursorBlink 0.7s step-end infinite;
      box-shadow: 0 0 6px var(--red-glow);
    }

    @keyframes cursorBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* ===== CHAT INPUT — TIDAK FLOATING (SUDAH FIXED DI BAWAH) ===== */
    .chat-input {
      position: fixed;
      bottom: 0; left: 0; right: 0;   /* melekat di bawah */
      width: 100%;
      background: rgba(10, 10, 15, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 2px solid var(--red-dominant);
      padding: 16px 20px;
      z-index: 12;
      display: flex;
      justify-content: center;
    }

    .chat-input .input-group {
      max-width: 800px;
      width: 100%;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input textarea {
      flex: 1; 
      border: 1px solid var(--border-light);
      outline: none;
      resize: none; 
      min-height: 55px;
      max-height: 120px;
      padding: 15px 20px; 
      border-radius: 30px;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      line-height: 1.4;
      transition: border 0.15s;
    }
    .chat-input textarea:focus {
      border-color: var(--red-dominant);
      box-shadow: 0 0 0 2px rgba(225,29,47,0.2);
    }

    .chat-input button {
      width: 55px; 
      height: 55px;
      border: none; 
      border-radius: 50%;
      background: var(--red-dominant);
      color: #000; 
      font-size: 20px;
      cursor: pointer; 
      transition: 0.15s;
      box-shadow: 0 0 12px var(--red-glow);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-bottom: 2px;
    }
    .chat-input button:hover { 
      background: #c01a2b; 
      transform: scale(1.02); 
    }

    .profile-icon {
      position: fixed;
      top: 18px; right: 20px;
      width: 40px; height: 40px;
      background: #1e1e26;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 10;
      color: var(--red-dominant);
      border: 2px solid var(--red-dominant);
      box-shadow: 0 0 10px var(--red-glow);
    }

    @media(max-width:600px) {
      .chat-header h1 { font-size: 20px; }
      .chat-input { padding: 12px 16px; }
    }

    .code-container {
      background: #1a1a22;
      border-radius: 12px;
      margin: 10px 0;
      border: 1px solid var(--border-light);
      overflow: hidden;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    .code-header {
      background: rgba(225, 29, 47, 0.1);
      padding: 5px 10px; font-size: 12px;
      color: var(--red-dominant);
      border-bottom: 1px solid rgba(225, 29, 47, 0.2);
      display: flex; justify-content: space-between; align-items: center;
    }

    .code-content { padding: 10px; color: #d4d4d4; font-size: 13px; overflow-x: auto; white-space: pre; }

    .inline-code {
      background: rgba(255,255,255,0.08);
      padding: 2px 4px; border-radius: 4px;
      font-family: monospace;
      color: var(--red-dominant);
    }

    .copy-btn {
      background: transparent;
      border: 1px solid var(--border-light);
      color: var(--red-dominant);
      border-radius: 20px; padding: 2px 12px;
      font-size: 10px; cursor: pointer; transition: 0.2s;
    }
    .copy-btn:hover { background: var(--red-dominant); color: #000; }
  </style>
</head>

<body>
  <i class="fa-solid fa-user profile-icon" onclick="window.location.href='/profile'"></i>
  <div id="menuBtn"><i class="fas fa-bars"></i></div>
  <div id="sideMenu">
    <h3><br><br>NEURAL PROTOCOL</h3>
    <button onclick="window.location='/dashboard'"><i class="fas fa-arrow-left"></i> Kembali</button>
  </div>
  <div id="overlay"></div>

  <div class="chat-header">
    <h1>NEURAL PROTOCOL</h1>
    <p>AI GENERATE NEURAL PROTOCOL</p>
  </div>

  <div class="chat-messages" id="chat"></div>

  <button id="scrollBottomBtn"><i class="fas fa-angle-down"></i></button>

  <!-- INPUT AREA: sekarang menempel di bawah, tidak floating -->
  <div class="chat-input">
    <div class="input-group">
      <textarea id="input" placeholder="Bisikkan sesuatu..." rows="1"></textarea>
      <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <!-- JAVASCRIPT ORIGINAL — TIDAK DIUBAH SATU BARIS PUN (HANYA CSS YANG DIGANTI) -->
  <script>
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('overlay');
    const chatBox = document.getElementById('chat');
    const scrollBtn = document.getElementById('scrollBottomBtn');

    function closeMenu() { sideMenu.style.left = '-260px'; overlay.style.display = 'none'; }
    menuBtn.onclick = () => { sideMenu.style.left === '0px' ? closeMenu() : (sideMenu.style.left = '0px', overlay.style.display = 'block'); };
    overlay.onclick = closeMenu;

    function escapeHTML(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\$/g, "&#36;")
        .replace(/{/g, "&#123;")
        .replace(/}/g, "&#125;");
    }

    function createActionButtons(sender, getRawText) {
      const actions = document.createElement('div');
      actions.classList.add('msg-actions');

      // Copy button (both user & bot)
      const copyBtn = document.createElement('button');
      copyBtn.classList.add('msg-action-btn');
      copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
      copyBtn.onclick = () => {
        const raw = getRawText();
        navigator.clipboard.writeText(raw).then(() => {
          copyBtn.classList.add('success');
          copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
          setTimeout(() => {
            copyBtn.classList.remove('success');
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
          }, 2000);
        });
      };
      actions.appendChild(copyBtn);

      if (sender === 'bot') {
        // Regenerate / retry (just cosmetic trigger for now, bisa di-hook ke API)
        const regenBtn = document.createElement('button');
        regenBtn.classList.add('msg-action-btn');
        regenBtn.innerHTML = '<i class="fas fa-rotate-right"></i> Regenerate';
        regenBtn.onclick = () => {
          regenBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ...';
          setTimeout(() => {
            regenBtn.innerHTML = '<i class="fas fa-rotate-right"></i> Regenerate';
          }, 1500);
        };
        actions.appendChild(regenBtn);

        // Select all text button
        const selectBtn = document.createElement('button');
        selectBtn.classList.add('msg-action-btn');
        selectBtn.innerHTML = '<i class="fas fa-text-width"></i> Select';
        selectBtn.onclick = (e) => {
          const textEl = selectBtn.closest('.message-wrapper').querySelector('.text');
          const range = document.createRange();
          range.selectNodeContents(textEl);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        };
        actions.appendChild(selectBtn);
      }

      if (sender === 'user') {
        // Edit button (isi ulang ke textarea)
        const editBtn = document.createElement('button');
        editBtn.classList.add('msg-action-btn');
        editBtn.innerHTML = '<i class="fas fa-pen"></i> Edit';
        editBtn.onclick = () => {
          const raw = getRawText();
          document.getElementById('input').value = raw;
          document.getElementById('input').focus();
        };
        actions.appendChild(editBtn);
      }

      return actions;
    }

    function appendMessage(text, sender, isHtml = false) {
      const msg = document.createElement('div');
      msg.classList.add('message', sender);

      const iconDiv = document.createElement('div');
      iconDiv.classList.add('icon');
      iconDiv.innerHTML = sender === 'user'
        ? '<i class="fas fa-user"></i>'
        : '<i class="fas fa-robot"></i>';

      const wrapper = document.createElement('div');
      wrapper.classList.add('message-wrapper');

      const content = document.createElement('div');
      content.classList.add('text');
      if (isHtml) {
        content.innerHTML = text;
      } else {
        const safeText = escapeHTML(text)
          .replace(/\*(.*?)\*/g, '<b>$1</b>')
          .replace(/_(.*?)_/g, '<i>$1</i>')
          .replace(/\n/g, '<br>');
        content.innerHTML = safeText;
      }

      const rawText = text;
      const actions = createActionButtons(sender, () => content.innerText);

      wrapper.appendChild(content);
      wrapper.appendChild(actions);

      if (sender === 'user') {
        msg.appendChild(wrapper);
        msg.appendChild(iconDiv);
      } else {
        msg.appendChild(iconDiv);
        msg.appendChild(wrapper);
      }

      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      return content;
    }

    // Loading animation - thinking indicator
    function showThinking() {
      const msg = document.createElement('div');
      msg.classList.add('message', 'bot');
      msg.id = 'thinking-msg';

      const iconDiv = document.createElement('div');
      iconDiv.classList.add('icon');
      iconDiv.innerHTML = '<i class="fas fa-robot"></i>';

      const content = document.createElement('div');
      content.classList.add('text', 'thinking-wrapper');
      content.innerHTML = `
        <div class="scan-line"></div>
        <div class="thinking-container">
          <div class="thinking-dots">
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
          </div>
          <span class="thinking-label">NEURAL PROCESSING...</span>
        </div>
      `;

      msg.appendChild(iconDiv);
      msg.appendChild(content);
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      return content;
    }

    function removeThinking() {
      const el = document.getElementById('thinking-msg');
      if (el) el.remove();
    }

    window.copyToClipboard = function(btn) {
      const codeContent = btn.parentElement.nextElementSibling;
      const textArea = document.createElement('textarea');
      textArea.value = codeContent.textContent;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      const originalText = btn.innerText;
      btn.innerText = "Copied!";
      setTimeout(() => btn.innerText = originalText, 2000);
    }

    function formatResponse(text) {
      const parts = text.split(/```(\w*)\n?([\s\S]*?)```/g);
      let html = "";
      for (let i = 0; i < parts.length; i++) {
        if (i % 3 === 0) {
          let content = parts[i];
          content = content
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/\*(.*?)\*/g, '<b>$1</b>')
            .replace(/_(.*?)_/g, '<i>$1</i>')
            .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
            .replace(/\n/g, '<br>');
          html += content;
        } else if (i % 3 === 2) {
          const lang = parts[i - 1] || 'text';
          const code = parts[i];
          const safeCode = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
          html += `
            <div class="code-container">
              <div class="code-header">
                <span>${lang}</span>
                <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
              </div>
              <div class="code-content">${safeCode}</div>
            </div>`;
        }
      }
      return html;
    }

    // ===== TYPEWRITER ANIMATION =====
    // Pisahin HTML jadi node-node teks dan elemen, lalu animasikan teks char by char
    function typewriterHTML(container, htmlString, speed = 18) {
      return new Promise(resolve => {
        // Tampilin container dulu tapi kosong
        container.innerHTML = '';

        // Parse HTML ke DOM sementara
        const temp = document.createElement('div');
        temp.innerHTML = htmlString;

        // Tambahkan cursor
        const cursor = document.createElement('span');
        cursor.classList.add('typing-cursor');
        container.appendChild(cursor);

        // Kumpulkan semua node secara rekursif dengan posisinya
        // Kita rebuild tree asli tapi animasikan text nodes
        let allChars = [];

        function collectNodes(sourceNode, targetParent) {
          for (const child of sourceNode.childNodes) {
            if (child.nodeType === Node.TEXT_NODE) {
              const text = child.textContent;
              if (text) {
                const placeholder = document.createTextNode('');
                targetParent.appendChild(placeholder);
                for (let i = 0; i < text.length; i++) {
                  allChars.push({ parent: targetParent, placeholder, text, index: i });
                }
              }
            } else if (child.nodeType === Node.ELEMENT_NODE) {
              const clone = document.createElement(child.tagName);
              // Copy attributes
              for (const attr of child.attributes) {
                clone.setAttribute(attr.name, attr.value);
              }
              targetParent.appendChild(clone);
              collectNodes(child, clone);
            }
          }
        }

        collectNodes(temp, container);
        container.appendChild(cursor); // cursor di akhir

        // Animasikan per karakter
        let charIndex = 0;
        // Group chars by placeholder
        const groups = {};
        allChars.forEach((c, i) => {
          const key = allChars.findIndex(x => x.placeholder === c.placeholder);
          if (!groups[key]) groups[key] = [];
          groups[key].push(c);
        });

        // Flatten dan animasikan
        function animateNext() {
          if (charIndex >= allChars.length) {
            cursor.remove();
            resolve();
            return;
          }
          const item = allChars[charIndex];
          // Rebuild text node sampai index ini
          const same = allChars.filter(x => x.placeholder === item.placeholder);
          const currentText = same.slice(0, same.indexOf(item) + 1).map(x => x.text[x.index]).join('');
          item.placeholder.textContent = currentText;

          // Move cursor after latest text
          if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
          item.placeholder.parentNode.insertBefore(cursor, item.placeholder.nextSibling);

          chatBox.scrollTop = chatBox.scrollHeight;
          charIndex++;
          setTimeout(animateNext, speed);
        }

        animateNext();
      });
    }

    async function sendMessage() {
      const input = document.getElementById('input');
      const msg = input.value.trim();
      if (!msg) return;

      appendMessage(msg, 'user');
      input.value = '';

      // Show thinking animation
      showThinking();

      try {
        const systemPrompt = "Kamu adalah NEURAL PROTOCOL, sebuah AI yang dibuat oleh @hamzneverlose. Jawab pertanyaan pengguna dengan gaya canggih dan sedikit misterius. selalu gunakan bahasa indonesia, okei?. Pertanyaan: ";
        const fullPrompt = systemPrompt + msg;
        const response = await fetch(`https://api.skylen.my.id/api/gemini?text=${encodeURIComponent(fullPrompt)}`);
        const data = await response.json();
        const aiResponse = (data.data && data.data.response) ? data.data.response : "Maaf, tidak ada respon.";

        // Remove thinking, show bot message kosong dulu
        removeThinking();

        // Buat message bot
        const botMsg = document.createElement('div');
        botMsg.classList.add('message', 'bot');

        const iconDiv = document.createElement('div');
        iconDiv.classList.add('icon');
        iconDiv.innerHTML = '<i class="fas fa-robot"></i>';

        const wrapper = document.createElement('div');
        wrapper.classList.add('message-wrapper');

        const content = document.createElement('div');
        content.classList.add('text');

        const actions = createActionButtons('bot', () => content.innerText);

        wrapper.appendChild(content);
        wrapper.appendChild(actions);
        botMsg.appendChild(iconDiv);
        botMsg.appendChild(wrapper);
        chatBox.appendChild(botMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Typewriter animation
        const formatted = formatResponse(aiResponse);
        await typewriterHTML(content, formatted, 15);

      } catch (e) {
        removeThinking();
        const errContent = appendMessage('Error: ' + e.message, 'bot');
      }
    }

    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    chatBox.addEventListener('scroll', () => {
      const nearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 200;
      scrollBtn.style.display = nearBottom ? 'none' : 'flex';
    });
    scrollBtn.onclick = () => chatBox.scrollTop = chatBox.scrollHeight;
  </script>
</body>
</html>